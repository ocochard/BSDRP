#!/usr/bin/env python
# vim: sta:et:sw=4:ts=4:sts=4
# -*- coding: utf-8 -*-
# Alexander V. Chernikov's script for displaying NIC queue usage/rate
# Improved by BSDRP team

from __future__ import division
import re
import sys
import subprocess
import time

if len(sys.argv) < 2:
    print("Usage: {} interface".format(sys.argv[0]))
    print("       with interface as cxl,ix,ixl,igb, bxe or oce")
    sys.exit(1)


def read_nic(name):
    " Parse sysctl value for each queues of the NIC "
    m = re.match('^(ix|ixl|cxl|igb|bxe|oce)(\d+)$', name)
    if not m:
        raise Exception('Invalid nic name: {}'.format(name))
    driver = m.group(1)
    rxq = {}
    txq = {}
    agg = {}
    for line in subprocess.check_output("/sbin/sysctl dev.{}.{}".format(m.group(1), m.group(2)).split(), universal_newlines=True).split("\n"):
        # dev.cxl.0.rxq.1.rxcsum
        # dev.cxl.0.txq.1.r_enqueues: 359615473
        # dev.cxl.0.stats.rx_frames
        # dev.ix.0.queue0.rx_packets: 45256216
        # dev.ix.0.queue0.tx_packets: 5
        # dev.ix.0.total_pkts_rcvd
        # dev.ix.0.total_pkts_txd
        # dev.ixl.1.pf.que1.tx_packets
        # dev.ixl.1.pf.que1.rx_packets
        # dev.ixl.0.mac.bcast_pkts_txd: 1
        # dev.ixl.0.mac.mcast_pkts_txd: 5
        # dev.ixl.0.mac.ucast_pkts_txd: 0
        # dev.ixl.0.mac.bcast_pkts_rcvd: 0
        # dev.ixl.0.mac.mcast_pkts_rcvd: 0
        # dev.ixl.0.mac.ucast_pkts_rcvd: 0
        # dev.igb.1.mac_stats.total_pkts_recvd
        # dev.igb.1.mac_stats.total_pkts_txd
        # dev.bxe.3.queue.0.rx_pkts
        # dev.bxe.3.queue.0.tx_pkts
        # dev.bxe.3.rx_bcast_packets: 1447
        # dev.bxe.3.rx_mcast_packets: 0
        # dev.bxe.3.rx_ucast_packets: 1524243
        # dev.oce.0.stats.rx.queue3.rx_pkts: 0
        # dev.oce.0.stats.tx.queue3.tx_pkts: 0
        # dev.oce.0.stats.rx.total_pkts:

        if driver == "bxe":
            m = re.match('.*\.queue.(\d+)\.tx_pkts:\s+(\d+)', line)
        elif driver == "cxl":
            m = re.match('.*\.txq\.(\d+)\.r_enqueues:\s+(\d+)', line)
        elif driver in ("ix", "igb"):
            m = re.match('.*\.queue(\d+)\.tx_packets:\s+(\d+)', line)
        elif driver == "ixl":
            m = re.match('.*\.pf.que(\d+)\.tx_packets:\s+(\d+)', line)
        elif driver == "oce":
            m = re.match('.*\.stats.tx.queue(\d+)\.tx_pkts:\s+(\d+)', line)
        if m:
            txq[m.group(1)] = int(m.group(2))
        if driver == "bxe":
            m = re.match('.*\.queue.(\d+)\.rx_pkts:\s+(\d+)', line)
        elif driver == "cxl":
            m = re.match('.*\.rxq\.(\d+)\.rxcsum:\s+(\d+)', line)
        elif driver in ("ix", "igb"):
            m = re.match('.*\.queue(\d+)\.rx_packets:\s+(\d+)', line)
        elif driver == "ixl":
            m = re.match('.*\.pf.que(\d+)\.rx_packets:\s+(\d+)', line)
        elif driver == "oce":
            m = re.match('.*\.stats.rx.queue(\d+)\.rx_pkts:\s+(\d+)', line)
        if m:
            rxq[m.group(1)] = int(m.group(2))
        if driver == "bxe":
            # To do: aggregate bcast/mcast and ucast
            m = re.match('.*\.rx_ucast_packets:\s+(\d+)', line)
        elif driver == "cxl":
            m = re.match('.*\.stats.rx_frames:\s+(\d+)', line)
        elif driver == "igb":
            m = re.match('.*\.total_pkts_recvd:\s+(\d+)', line)
        elif driver == "ix":
            m = re.match('.*\.total_pkts_rcvd:\s+(\d+)', line)
        elif driver == "ixl":
            # To do: aggregate bcas/mcast and ucast
            m = re.match('.*\.mac.ucast_pkts_rcvd:\s+(\d+)', line)
        elif driver == "oce":
            m = re.match('.*\.stats.rx.total_pkts:\s+(\d+)', line)
        if m:
            agg['rx_sum'] = int(m.group(1))
        if driver == "bxe":
            # To do: aggregate bcast/mcast and ucast
            m = re.match('.*\.tx_ucast_packets:\s+(\d+)', line)
        if driver in ("ix", "igb"):
            m = re.match('.*\.total_pkts_txd:\s+(\d+)', line)
        elif driver == "ixl":
            m = re.match('.*\.mac.ucast_pkts_txd:\s+(\d+)', line)
        elif driver == "cxl":
            m = re.match('.*\.stats.tx_frames:\s+(\d+)', line)
        elif driver == "oce":
            m = re.match('.*\.stats.tx.total_tx_pkts:\s+(\d+)', line)
        if m:
            agg['tx_sum'] = int(m.group(1))
    return [rxq, txq, agg]


def make_diff(old_ret, new_ret):
    " Doing diff between previous value and new one "
    rxq = {}
    txq = {}
    agg = {}
    for i in old_ret[0]:
        rxq[i] = new_ret[0][i] - old_ret[0][i]
        txq[i] = new_ret[1][i] - old_ret[1][i]

    for i in old_ret[2]:
        agg[i] = new_ret[2][i] - old_ret[2][i]

    return [rxq, txq, agg]


def print_diff(diff):
    " Displaying the diff between previous value and new one "
    line = ""
    rx_sum = 0
    tx_sum = 0
    for i in range(len(diff[0])):
        val = str(i)
        rx_val = int(diff[0][val])
        tx_val = int(diff[1][val])
        rx_sum += rx_val
        tx_sum += tx_val
        line += "[Q{0} {1:5d}K/s] ".format(val, rx_val // 1000)
    line += "[Q{0} {1:5d}K/s {2:5d}K/s -> {3:5d}K/s]".format("T", rx_sum // 1000,
            diff[2]['rx_sum'] // 1000, diff[2]['tx_sum'] // 1000)

    print(line)


def run_nic(name):
    " Main loop function "
    ret = []
    while True:
        ret_new = read_nic(name)
        if not ret:
            ret = ret_new
            time.sleep(1)
            continue

        diff = make_diff(ret, ret_new)
        ret = ret_new
        print_diff(diff)
        time.sleep(1)


run_nic(sys.argv[1])
