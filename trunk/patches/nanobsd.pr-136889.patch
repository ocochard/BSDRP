--- nanobsd.sh.orig	2011-08-30 21:23:05.000000000 +0200
+++ nanobsd.sh	2011-08-30 21:29:32.000000000 +0200
@@ -135,6 +135,9 @@
 # Can be "file" or "swap"
 NANO_MD_BACKING="file"
 
+# for swap type md(4) backing, write out the mbr only
+NANO_IMAGE_MBRONLY=true
+
 # Progress Print level
 PPLEVEL=3
 
@@ -166,6 +169,13 @@
 #
 #######################################################################
 
+nano_cleanup() {
+   if [ $? -ne 0 ]; then
+       echo "Error encountered.  Check for errors in last log file." 1>&2
+    fi
+    exit $?
+}
+
 clean_build ( ) (
 	pprint 2 "Clean and create object directory (${MAKEOBJDIRPREFIX})"
 
@@ -390,7 +400,7 @@
 prune_usr() (
 
 	# Remove all empty directories in /usr 
-	find ${NANO_WORLDDIR}/usr -type d -depth -print |
+	find ${NANO_WORLDDIR}/usr -type d -depth -not -name aout -print |
 		while read d
 		do
 			rmdir $d > /dev/null 2>&1 || true 
@@ -567,8 +577,13 @@
 	fi
 
 	if [ "${NANO_MD_BACKING}" = "swap" ] ; then
-		echo "Writing out ${NANO_IMGNAME}..."
-		dd if=/dev/${MD} of=${IMG} bs=64k
+		if [ ${NANO_IMAGE_MBRONLY} ]; then
+			echo "Writing out _.disk.mbr..."
+			dd if=/dev/${MD} of=${NANO_DISKIMGDIR}/_.disk.mbr bs=512 count=1
+		else
+			echo "Writing out ${NANO_IMGNAME}..."
+			dd if=/dev/${MD} of=${IMG} bs=64k
+		fi
 	fi
 
 	if ${do_copyout_partition} ; then
@@ -578,6 +593,7 @@
 	mdconfig -d -u $MD
 
 	trap - 1 2 15 EXIT
+	trap "nano_cleanup" EXIT
 
 	) > ${NANO_OBJ}/_.di 2>&1
 )
@@ -1063,7 +1079,7 @@
 	echo "	-i	suppress disk image build"
 	echo "	-k	suppress buildkernel"
 	echo "	-n	add -DNO_CLEAN to buildworld, buildkernel, etc"
-	echo "	-q	make output more quiet"
+	echo "	-q	make output quieter"
 	echo "	-v	make output more verbose"
 	echo "	-w	suppress buildworld"
 	echo "	-c	specify config file"
@@ -1144,6 +1160,7 @@
 	echo "$0: Extraneous arguments supplied"
 	usage
 fi
+trap "nano_cleanup" EXIT
 
 #######################################################################
 # Setup and Export Internal variables
